// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL")
}

/**
 * Role-Based Access Control (RBAC) Models
 */
model Role {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  alias       String?
  is_admin    Boolean          @default(false)
  is_default  Boolean
  created_at  DateTime         @default(now())
  updated_at  DateTime         @updatedAt
  users       User[]
  permissions RolePermission[]
}

model Permission {
  id         Int              @id @default(autoincrement())
  name       String           @unique
  group_name String?
  created_at DateTime?
  roles      RolePermission[]
}

model RolePermission {
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model NotificationType {
  id                   Int                    @id @default(autoincrement())
  name                 String                 @unique
  notificationTemplate NotificationTemplate[]
}

model NotificationTemplate {
  id                 String                   @id @default(uuid())
  subject            String?
  default_content    String?
  custom_content     String?
  type               NotificationTemplateType @default(MAIL)
  notificationTypeId Int
  created_at         DateTime                 @default(now())
  updated_at         DateTime                 @updatedAt

  notificationType NotificationType @relation(fields: [notificationTypeId], references: [id])
}

model User {
  id                  String    @id @default(uuid())
  supabaseId          String?   @unique // Link to Supabase auth.users.id (UUID)
  email               String    @unique
  email_verified_date DateTime?
  phone               String?   @unique
  password            String?
  first_name          String?
  last_name           String?
  image               String?
  is_activated        Boolean   @default(false)
  is_deleted          Boolean   @default(false)
  roleId              Int
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  // Relations
  role              Role                      @relation(fields: [roleId], references: [id], onDelete: Restrict)
  businessProfile   BusinessProfile[]
  account           Account[]
  session           Session[]
  notifications     ApplicationNotification[] @relation("ReceivedNotifications") // Added relation name
  sentNotifications ApplicationNotification[] @relation("SentNotifications") // Added for sender
  //activities        UserActivity[] // User's own actions
  preference        NotificationPreference[]
  // conversation      Conversation[]
  conversations     ConversationUser[]
  message           Message[]
}

model BusinessProfile {
  id                String   @id @default(uuid())
  userId            String
  company_name      String   @unique
  phone_number      String
  business_number   String?  @unique // Business WhatsApp phone number
  company_location  String?
  company_website   String?
  business_industry String?
  business_category String?
  annual_revenue    String?
  business_email    String?
  business_logo_url String?
  business_bio      String?
  business_hour     Json?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id])
  Categories Category[]
  Products   Product[]
  Contact    Contact[]
  Order      Order[]

  tags Tag[]

  userActivities UserActivity[]
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id          Int      @id @default(autoincrement())
  identifier  String
  token       String   @unique
  isTokenUsed Boolean  @default(false)
  expires     DateTime

  @@unique([identifier, token])
}

model ApplicationNotification {
  id          String                   @id @default(uuid())
  recipientId String // User receiving the notification
  senderId    String? // Optional: User sending it (e.g., a seller messaging a buyer)
  type        AppNotificationType      @default(SYSTEM) // e.g., 'order_update', 'new_message', 'product_review', 'promotion'
  channel     NotificationTemplateType @default(IN_APP)
  title       String // Short subject, e.g., "Order Shipped!"
  body        String? // Detailed message, e.g., "Your iPhone order #123 is on its way."
  data        Json? // Flexible payload, e.g., { orderId: "abc", productName: "iPhone" }
  isRead      Boolean                  @default(false)
  isDeleted   Boolean                  @default(false) // Soft delete for cleanup
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt
  expiresAt   DateTime? // optional TTL/expiration for promo notifications

  // Relations
  // Relations with explicit names
  recipient User  @relation("ReceivedNotifications", fields: [recipientId], references: [id], onDelete: Cascade)
  sender    User? @relation("SentNotifications", fields: [senderId], references: [id], onDelete: SetNull)

  @@index([recipientId]) // For fast queries by user
  @@index([type, createdAt(sort: Desc)]) // For filtering/sorting notifications
}

model NotificationPreference {
  id        String                   @id @default(uuid())
  userId    String
  type      AppNotificationType
  channel   NotificationTemplateType
  enabled   Boolean                  @default(true)
  updatedAt DateTime                 @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, channel])
}

model Category {
  id                String   @id @default(uuid())
  businessProfileId String
  name              String
  slug              String
  description       String?
  parentCategoryId  String?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  businessProfile BusinessProfile @relation(fields: [businessProfileId], references: [id])
  parentCategory  Category?       @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  subCategories   Category[]      @relation("CategoryHierarchy")
  products        Product[]

  @@unique([businessProfileId, slug])
}

model Product {
  id                String        @id @default(uuid())
  businessProfileId String
  categoryId        String
  name              String
  slug              String        @unique
  description       String?
  price             Decimal       @db.Decimal(10, 2)
  sku               String?
  stock             Int           @default(0)
  status            ProductStatus @default(DRAFT)
  currency          CurrencyType  @default(NAIRA)
  deleted           Boolean       @default(false)
  deletedAt         DateTime?
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt

  businessProfile BusinessProfile  @relation(fields: [businessProfileId], references: [id])
  category        Category         @relation(fields: [categoryId], references: [id])
  media           ProductMedia[]
  variants        ProductVariant[]
  OrderItem       OrderItem[]

  @@unique([businessProfileId, name])
  @@unique([businessProfileId, sku])
  @@index([businessProfileId])
  @@index([categoryId])
  @@index([status])
  @@index([deleted])
  @@index([name])
}

model ProductMedia {
  id         String   @id @default(uuid())
  productId  String
  url        String
  altText    String?
  order      Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model ProductVariant {
  id         String   @id @default(uuid())
  productId  String
  sku        String?
  price      Decimal  @db.Decimal(10, 2)
  stock      Int      @default(0)
  attributes Json? // Store option name/value pairs
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Tag {
  id                String   @id @default(uuid())
  businessProfileId String
  name              String   @unique
  color             String?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  businessProfile BusinessProfile @relation(fields: [businessProfileId], references: [id])
  contacts        ContactTag[]

  @@unique([businessProfileId, name])
  @@index([businessProfileId])
  @@index([name])
}

model Contact {
  id                String        @id @default(uuid())
  businessProfileId String
  name              String?
  phone_number      String
  email             String?
  whatsapp_opt_in   Boolean       @default(true)
  status            ContactStatus @default(ACTIVE) // e.g., ACTIVE, BLOCKED, UNSUBSCRIBED
  source            ContactSource @default(MANUAL) // e.g., imported, chatbot, API, form
  custom_fields     Json? // e.g., { "city": "Lagos", "gender": "Male" }
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt

  // Relations
  businessProfile BusinessProfile @relation(fields: [businessProfileId], references: [id])
  contactTag      ContactTag[]
  conversations   Conversation[] // Link to chat history if needed
  Order           Order[]
  UserActivity    UserActivity[]

  @@unique([businessProfileId, phone_number])
  @@index([businessProfileId])
  @@index([phone_number])
  @@index([status])
}

model ContactTag {
  id        String   @id @default(uuid())
  contactId String
  tagId     String
  createdAt DateTime @default(now())

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([contactId, tagId])
  @@index([contactId])
  @@index([tagId])
}

model Order {
  id                String        @id @default(uuid())
  businessProfileId String
  contactId         String
  order_number      String        @unique
  status            OrderStatus   @default(PENDING)
  total_amount      Decimal       @db.Decimal(10, 2)
  currency          CurrencyType  @default(NAIRA)
  payment_status    PaymentStatus @default(PENDING)
  payment_method    String?
  delivery_address  Json?
  notes             String?
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt

  businessProfile BusinessProfile @relation(fields: [businessProfileId], references: [id])
  contact         Contact         @relation(fields: [contactId], references: [id])
  OrderItem       OrderItem[]
  UserActivity    UserActivity[]  @relation(name: "OrderActivities")

  @@index([businessProfileId])
  @@index([contactId])
  @@index([order_number])
}

model OrderItem {
  id         String   @id @default(uuid())
  orderId    String
  productId  String?
  name       String
  quantity   Int      @default(1)
  price      Decimal  @db.Decimal(10, 2)
  total      Decimal  @db.Decimal(10, 2)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])
}

model UserActivity {
  id                String   @id @default(uuid())
  businessProfileId String
  name              String? // The user who performed the action
  contactId         String?
  orderId           String?
  type              String // e.g., 'order_placed', 'product_reviewed', 'cart_added'
  description       String // Human-readable log, e.g., "Added iPhone to cart"
  metadata          Json? // e.g., { productId: "xyz", quantity: 1 }
  created_at        DateTime @default(now())

  // Relation
  //user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessProfile BusinessProfile @relation(fields: [businessProfileId], references: [id])
  contact         Contact?        @relation(fields: [contactId], references: [id])
  order           Order?          @relation(fields: [orderId], references: [id], name: "OrderActivities")
  //@@index([type, createdAt(sort: Desc)]) // For timelines

  @@index([businessProfileId])
  @@index([contactId])
  @@index([orderId])
}

// Conversation (WhatsApp/Chat support)
model Conversation {
  id         String             @id @default(cuid())
  contactId  String?
  status     ConversationStatus @default(OPEN)
  isGroup    Boolean            @default(false)
  created_at DateTime           @default(now())
  updated_at DateTime           @updatedAt

  // Relations
  contact  Contact?           @relation(fields: [contactId], references: [id])
  users    ConversationUser[]
  messages Message[]
}

model ConversationUser {
  userId         String
  conversationId String
  joinedAt       DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id])

  @@id([userId, conversationId])
}

// Message (Chat messages)
model Message {
  id             String           @id @default(cuid())
  conversationId String
  content        String
  direction      MessageDirection
  senderId       String?
  is_deleted     Boolean          @default(false)
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id])
  user         User?        @relation(fields: [senderId], references: [id])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum ConversationStatus {
  OPEN
  CLOSED
}

enum MessageDirection {
  PENDING
  SENT
  RECEIVED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENT
  COMPLETED
}

enum MessageStatus {
  PENDING
  SENT
  FAILED
}

enum NotificationTemplateType {
  IN_APP
  SMS
  MAIL
  DATABASE
  PUSH
}

enum AppNotificationType {
  REGISTRATION
  ORDER_UPDATE
  ORDER_PLACED
  NEW_MESSAGE
  PRODUCT_REVIEW
  PROMOTION
  PRICE_DROP
  SHIPPING_UPDATE
  SYSTEM
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum CurrencyType {
  NAIRA
  DOLLAR
  POUND
  EURO
  CNY
}

enum ContactStatus {
  ACTIVE
  BLOCKED
  UNSUBSCRIBED
}

enum ContactSource {
  MANUAL
  IMPORT
  API
  WHATSAPP
  CHATBOT
}
